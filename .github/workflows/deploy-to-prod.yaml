name: Terraform PROD Deployment

on:
  push:
    branches:
      - main
  workflow_run:
    workflows: ["Build and Publish Docker Image"]
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  gcp-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Git Repository
        uses: actions/checkout@v3.0.0
        with:
          fetch-depth: 0

      - id: "auth"
        name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GOOGLE_CREDENTIALS }}"
          create_credentials_file: true
          export_environment_variables: true

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tagging ${{ github.sha }} as lastest
        run: |
          docker pull ghcr.io/${{ github.repository }}/sre-challenge-app:${{ github.sha }}
          docker tag ghcr.io/${{ github.repository }}/sre-challenge-app:${{ github.sha }} ghcr.io/${{ github.repository }}/sre-challenge-app:latest
          docker push ghcr.io/${{ github.repository }}/sre-challenge-app:latest

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v2"

      - name: install google-cloud-sdk-gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin

      - name: Terraform init and validate
        run: |
          terraform init
          terraform validate

      - name: Terraform plan
        run: |
          terraform plan

      - uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ github.actor }}
          minimum-approvals: 1
          issue-title: "Deploying ${{ github.sha }} to prod"
          issue-body: "Review the terraform plan, then approve or deny the deployment of ${{ github.sha }} to prod."
          exclude-workflow-initiator-as-approver: false

      - name: Terraform apply
        run: |
          terraform apply -auto-approve
